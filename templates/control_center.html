{% extends 'base.html' %}
{% block body %}
<div class="container theme-showcase" role="main">

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
        <h1>Scratbot Control Center</h1>
        <p></p>
    </div>

   	<div class="alert alert-success" role="alert" id="status_div">
        Dummy status message
 	</div>

    <div class="page-header">
        <h1>Controls</h1>
    </div>
    <form class="bs-example bs-example-form" method="post">
        <div class="row">
            <div class="col-lg-3">
                <div class="input-group">
                    <input id="move_distance" type="text" placeholder="200" class="form-control" aria-label="...">
                    <div class="input-group-btn">
                        <button id="move_forward_button" type="button" class="btn btn-default">Forward</button>
                        <button id="move_reverse_button" type="button" class="btn btn-default">Reverse</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="input-group">
                    <input id="rotate_degrees" type="text" placeholder="90" class="form-control" aria-label="...">
                    <div class="input-group-btn">
                        <button id="rotate_clockwise_button" type="button" class="btn btn-default">Clockwise</button>
                        <button id="rotate_counterclockwise_button" type="button" class="btn btn-default">CounterCW</button>
                    </div>
                </div>
            </div>
             <p>
        <button id="scan_button" type="button" class="btn btn-primary">Scan</button>
        <button id="kill_button" type="button" class="btn btn-danger">Kill</button>
      </p>
        </div>
    </form>
    <div class="page-header">
        <h1>Data</h1>
    </div>
    <div class="row">
        <div class="col-md-6">
            <table id="obstacle_table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Angle</th>
                        <th>Distance (cm)</th>
                        <th>Width (cm)</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <div class="col-md-6">
            <ul class="nav nav-pills">
                <li role="presentation" class="active"><a href="#scan">Scan</a></li>
                <li role="presentation"><a href="#map">Map</a></li>
                <li role="presentation"><a href="#video">Video</a></li>
            </ul>

        </div>
    </div>
</div>
<script>
    var req;
    function getStatus() {
        req = new XMLHttpRequest();
        req.open('GET', 'api/getstatus', true);
        req.onreadystatechange = ClientSideUpdate;
        req.send();
    }

    function ClientSideUpdate() {
        var result;

        if (req.readyState == 4) {
            result = req.responseText;

            var statuses = JSON.parse(result)["statuses"];
            var scan_results = JSON.parse(result)["scan_results"];

            if (statuses != null) {
                var status_div = document.getElementById("status_div");
                status_div.style.visibility="visible";
                for (key in statuses) {
                    if (statuses[key].type == 'status') {
                        console.log('asdf');
                        if (statuses[key].code == 0) {
                            status_div.setAttribute('class', "alert alert-success");
                            status_div.innerHTML = "<strong>Success! </strong>" + statuses[key].result;
                        }
                        else {
                            status_div.setAttribute('class', "alert alert-danger");
                            status_div.innerHTML = "<strong>Aborted!</strong> " + statuses[key].string + statuses[key].result;
                        }
                    } else if (statuses[key].type == 'scan_result') {
                        var table = document.getElementById("obstacle_table");
                        var status_div = document.getElementById("status_div");
                        status_div.style.visibility="visible";
                        status_div.setAttribute('class', "alert alert-info");
                        status_div.innerHTML = "<strong>Done!</strong> Scan found " + statuses.length + " obstacles";
                        var row = table.insertRow(-1);
                        var c1 = row.insertCell(0);
                        var c2 = row.insertCell(1);
                        var c3 = row.insertCell(2);
                        c1.innerHTML = statuses[key].angle;
                        c2.innerHTML = statuses[key].distance;
                        c3.innerHTML = statuses[key].size;
                    }
                }
            }
        }
    }

    function SendMoveForward() {
        var do_move = new XMLHttpRequest();
        var params = "distance=" + document.getElementById("move_distance").value;
        do_move.open('POST', 'api/moveforward');
        do_move.send(params);
    }

    function SendMoveReverse() {
        var do_move = new XMLHttpRequest();
        var params = "distance=" + document.getElementById("move_distance").value;
        do_move.open('POST', 'api/movereverse');
        do_move.send(params);
    }

    function SendRotateClockwise() {
        var do_move = new XMLHttpRequest();
        var params = "degrees=" + document.getElementById("rotate_degrees").value;
        do_move.open('POST', 'api/rotateclockwise');
        do_move.send(params);
    }

    function SendRotateCounterclockwise() {
        var do_move = new XMLHttpRequest();
        var params = "degrees=" + document.getElementById("rotate_degrees").value;
        do_move.open('POST', 'api/rotatecounterclockwise');
        do_move.send(params);
    }

     function SendScan() {
        var do_move = new XMLHttpRequest();
        do_move.open('POST', 'api/sendscan');
        do_move.send();
    }

     function SendKill() {
        var do_move = new XMLHttpRequest();
        do_move.open('POST', 'api/sendkill');
        do_move.send();
    }

    window.onload = function() {
        document.getElementById("status_div").style.visibility = "hidden";
        document.getElementById("move_forward_button").addEventListener('click', SendMoveForward);
        document.getElementById("move_reverse_button").addEventListener('click', SendMoveReverse);
        document.getElementById("rotate_clockwise_button").addEventListener('click', SendRotateClockwise);
        document.getElementById("rotate_counterclockwise_button").addEventListener('click', SendRotateCounterclockwise);
        document.getElementById("scan_button").addEventListener('click', SendScan);
        document.getElementById("kill_button").addEventListener('click', SendKill);
    };

    getStatus();
    setInterval(getStatus, 1000);
</script>
{% endblock %}
